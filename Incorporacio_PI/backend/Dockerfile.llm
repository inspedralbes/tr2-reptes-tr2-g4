# Fem servir Alpine Linux (molt més lleuger i ràpid de descarregar)
FROM alpine:latest

# Build argument to force cache invalidation (updates date manually if needed)
ARG BUILD_DATE=2025-01-25

# 1. Instal·lem eines de compilació i curl per al healthcheck
RUN apk add --no-cache build-base git cmake linux-headers curl-dev curl

WORKDIR /app

# 2. Clonem i compilem llama.cpp (versió lleugera)
RUN git clone --depth 1 https://github.com/ggerganov/llama.cpp.git .
RUN cmake -B build -DGGML_BACKTRACE=OFF -DGGML_NATIVE=ON
RUN cmake --build build --config Release --target llama-server -j4
RUN cp build/bin/llama-server .

# 3. Preparem l'execució
EXPOSE 8080
ENTRYPOINT ["./llama-server"]